<!-- Garrett Goodney & Ben Utter -->
<!-- Database Systems G01 -->
<!-- 12/7/23 -->
<!-- DBMS Final Project -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #taskInput, #timeInput, #dayInput {
            display: none; 
            width: 200px;
            margin-right: 10px;
        }
        #addTaskBtn {
            display: none;
            cursor: pointer;
        }
        #taskList {
            display: none;  
        }
        #loggedInUser {
        position: fixed;
        top: 10px;
        right: 20px;
    }
        #loginPopup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border: 1px solid #ccc;
            text-align: center;

            #calendar {
            margin-top: 20px;
            border-collapse: collapse;
        }
        #calendar th, #calendar td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            position: relative;
        }
        .day {
            position: absolute;
            top: 5px;
            left: 5px;
        }
        .tasks {
            position: relative;
            margin-top: 20px;
        }
        .task {
            margin-bottom: 5px;
            white-space: nowrap;
            position: relative;
        }
        .actions {
            margin-left: 10px;
            display: inline-block;
        }
        }
    </style>
</head>

<body>
    <!-- login screen -->
    <div id="loginPopup">
        <input type="text" id="usernameInput" placeholder="Username">
        <input type="password" id="passwordInput" placeholder="Password">
        <button id="loginBtn">Login</button>
        <button id="registerBtn">Register</button>
    </div>

    <div id="loggedInUser"></div>

    <!-- main task add boxes -->
    <h1>Task Manager</h1>
    <input type="text" id="taskInput" placeholder="Enter task">
    <input type="time" id="timeInput">
    <input type="date" id="dayInput">
    <button id="addTaskBtn">Add Task</button>
    <ul id="taskList"></ul>

    <!-- calendar -->
    <h2 id="monthYear" style="display: none">Calendar</h2>
    <table id="calendar" style="display: none">
        <thead>
            <tr>
                <th>Sun</th>
                <th>Mon</th>
                <th>Tue</th>
                <th>Wed</th>
                <th>Thu</th>
                <th>Fri</th>
                <th>Sat</th>
            </tr>
        </thead>
        <tbody id="calendarBody"></tbody>
    </table>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const taskInput = document.getElementById("taskInput");
            const timeInput = document.getElementById("timeInput");
            const dayInput = document.getElementById("dayInput");
            const addTaskBtn = document.getElementById("addTaskBtn");
            const taskList = document.getElementById("taskList");
            const loginPopup = document.getElementById("loginPopup");
            const loggedInUser = document.getElementById("loggedInUser");
            const registerBtn = document.getElementById("registerBtn");
            const loginBtn = document.getElementById("loginBtn");
            const calendarBody = document.getElementById("calendarBody");
            const monthYearHeader = document.getElementById("monthYear");

//show on login
            function showCalendar() {
                const calendar = document.getElementById("calendar");
                const monthYear = document.getElementById("monthYear");
                calendar.style.display = "block";
                monthYear.style.display = "block";
            }

            function showTaskElements() {
                taskInput.style.display = "block";
                timeInput.style.display = "block";
                dayInput.style.display = "block";
                addTaskBtn.style.display = "block";
                taskList.style.display = "block";
            }

            function hideLoginElements() {
                loginPopup.style.display = "none";
            }

//get all tasks
            function fetchAndDisplayTasks() {
                const userId = localStorage.getItem('userId');

                fetch(`http://localhost:3000/getTasks?userId=${userId}`)
                    .then(response => response.json())
                    .then(tasks => {
                        taskList.innerHTML = '';

                        tasks.forEach(task => {
                            const taskItem = document.createElement("li");
                            taskItem.textContent = `${task.taskText} - Time: ${task.taskTime}, Day: ${task.taskDay}`;
                            const deleteBtn = document.createElement("button");
                            deleteBtn.textContent = "Delete";
                            deleteBtn.addEventListener("click", () => deleteTask(task.id));
                            taskItem.appendChild(deleteBtn);
                            taskList.appendChild(taskItem);
                        });
                    })
                    .catch(error => console.error('error:', error));
            }

//delete a task
            function deleteTask(taskId) {
                fetch(`http://localhost:3000/deleteTask/${taskId}`, {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    fetchAndDisplayTasks();
                })
                .catch(error => console.error('error:', error));
            }

//create new task
            addTaskBtn.addEventListener("click", function () {
                const taskText = taskInput.value.trim();
                const taskTime = timeInput.value;
                const taskDay = dayInput.value;

                if (taskText === "" || taskTime === "" || taskDay === "") {
                    alert("Please fill in all fields!");
                    return;
                }

                if (taskText !== "") {
                    const taskItem = document.createElement("li");
                    taskItem.textContent = `${taskText} - Time: ${taskTime}, Day: ${taskDay}`;
                    taskList.appendChild(taskItem);

                    fetch('http://localhost:3000/addTask', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'User-Id': localStorage.getItem('userId'),
                        },
                        body: JSON.stringify({ taskText, taskTime, taskDay }),
                    })
                        .then(response => response.json())
                        .then(data => console.log(data))
                        .catch(error => console.error('error:', error));

                    taskInput.value = "";
                    timeInput.value = "";
                    dayInput.value = "";
                }
                updateCalendar(taskText, taskTime, taskDay);
                fetchAndDisplayTasks();
            });

//register
            loginPopup.style.display = 'block';

            registerBtn.addEventListener("click", () => {
                const username = document.getElementById("usernameInput").value;
                const password = document.getElementById("passwordInput").value;

                if (username && password) {
                    fetch('http://localhost:3000/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, password }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        alert('Registration successful!');
                    })
                    .catch(error => console.error('error:', error));
                } 
                else {
                    alert("Please enter a username and password");
                }
            });

//log in
            loginBtn.addEventListener("click", () => {
                const username = document.getElementById("usernameInput").value;
                const password = document.getElementById("passwordInput").value;

                if (username && password) {
                    fetch('http://localhost:3000/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, password }),
                    })

                    .then(response => response.json())
                    .then(data => {
                        if (data.user) {
                            localStorage.setItem('userId', data.user.id);
                            loggedInUser.textContent = `Logged In: ${data.user.username}`;
                            hideLoginElements();
                            showTaskElements();
                            fetchAndDisplayTasks();
                            showCalendar();
                        } else {
                            alert("Invalid username or password");
                        }
                    })

                    .catch(error => {
                        console.error('error:', error);
                        alert("Invalid username or password");
                    });
                } 
                else {
                    alert("Please enter a username and password");
                }
            });

//update the calendar
            function updateCalendar(taskText, taskTime, taskDay) {
                const date = new Date(`${taskDay}T${taskTime}`);
                const dayOfMonth = date.getUTCDate();
                const dayOfWeek = date.getUTCDay();
                const calendarCell = document.querySelector(`#calendarBody td[data-day="${dayOfMonth}"] .tasks`);

                const taskDiv = document.createElement("div");
                taskDiv.className = "task";
                taskDiv.textContent = `${taskText} - Time: ${taskTime}`;

                const actionsDiv = document.createElement("div");
                actionsDiv.className = "actions";

                const editButton = document.createElement("button");
                editButton.textContent = "Edit";
                editButton.addEventListener("click", function () {
                    editTask(taskDiv);
                });

                const deleteButton = document.createElement("button");
                deleteButton.textContent = "Delete";
                deleteButton.addEventListener("click", function () {
                    deleteTask(taskDiv);
                });

                actionsDiv.appendChild(editButton);
                actionsDiv.appendChild(deleteButton);
                taskDiv.appendChild(actionsDiv);

                calendarCell.appendChild(taskDiv);
            }

//edit a task (calendar only)
            function editTask(taskDiv) {
                const currentText = taskDiv.textContent;
                const newName = prompt("Edit task name:", currentText.split(" - ")[0]);
                const newTime = prompt("Edit task time:", currentText.split(" - ")[1]);

                if (newName !== null && newTime !== null) {
                    taskDiv.textContent = `${newName} - Time: ${newTime}`;
                }
            }

            function deleteTask(taskDiv) {
                if (confirm("Are you sure you want to delete this task?")) {
                    taskDiv.parentNode.removeChild(taskDiv);
                }
            }

            function generateCalendar(year, month) {
                const calendarBody = document.querySelector("#calendarBody");

                // Clear previous calendar
                while (calendarBody.firstChild) {
                    calendarBody.removeChild(calendarBody.firstChild);
                }

                const firstDayOfMonth = new Date(Date.UTC(year, month+1, 1));
                const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
                const dayOfWeek = firstDayOfMonth.getUTCDay();

                // Set the month and year in the header
                const monthYearText = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(firstDayOfMonth);
                monthYearHeader.textContent = `Calendar - ${monthYearText}`;

                // Populate calendar days
                let currentDay = 1;
                for (let week = 0; week < 6; week++) {
                    const tr = document.createElement("tr");
                    calendarBody.appendChild(tr);

                    for (let day = 0; day < 7; day++) {
                        const td = document.createElement("td");
                        if (week === 0 && day < dayOfWeek) {
                            // Empty cell before the first day of the month
                            td.textContent = '';
                        } else if (currentDay <= daysInMonth) {
                            // Populate the actual days of the month
                            td.setAttribute("data-day", currentDay);

                            const dayDiv = document.createElement("div");
                            dayDiv.className = "day";
                            dayDiv.textContent = currentDay;
                            td.appendChild(dayDiv);

                            const tasksDiv = document.createElement("div");
                            tasksDiv.className = "tasks";
                            td.appendChild(tasksDiv);

                            currentDay++;
                        }
                        tr.appendChild(td);
                    }
                }
            }

            function getCurrentYearAndMonth() {
                const currentDate = new Date();
                const currentYear = currentDate.getUTCFullYear();
                const currentMonth = currentDate.getUTCMonth();
                return { currentYear, currentMonth };
            }

            const { currentYear, currentMonth } = getCurrentYearAndMonth();
            generateCalendar(currentYear, currentMonth);
        });
    </script>
</body>
</html>
